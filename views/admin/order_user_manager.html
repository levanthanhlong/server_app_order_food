<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Trang Admin - Qu·∫£n l√Ω Orders</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link href="/assets/css/order_user_manager.css" rel="stylesheet" />
  </head>
  <body>
    <aside class="sidebar">
      <h1>Admin M√≥n ƒÇn</h1>
      <nav>
        <ul>
          <li><a href="/homeAdmin">üçΩÔ∏è Qu·∫£n l√Ω m√≥n ƒÉn</a></li>
          <li>
            <a href="/homeAdmin/userManagerPage">üë• Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</a>
          </li>
          <li><a href="/api/user/logout" class="logout">üö™ ƒêƒÉng Xu·∫•t</a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <h2>Danh S√°ch Orders c·ªßa ng∆∞·ªùi d√πng</h2>
        <div class="order-filter-container">
          <label for="month">Th√°ng:</label>
          <select id="month">
            <option value="">-- Ch·ªçn th√°ng --</option>
            <option value="1">Th√°ng 1</option>
            <option value="2">Th√°ng 2</option>
            <option value="3">Th√°ng 3</option>
            <option value="4">Th√°ng 4</option>
            <option value="5">Th√°ng 5</option>
            <option value="6">Th√°ng 6</option>
            <option value="7">Th√°ng 7</option>
            <option value="8">Th√°ng 8</option>
            <option value="9">Th√°ng 9</option>
            <option value="10">Th√°ng 10</option>
            <option value="11">Th√°ng 11</option>
            <option value="12">Th√°ng 12</option>
          </select>
          <label for="year">NƒÉm:</label>
          <select id="year">
            <option value="">-- Ch·ªçn nƒÉm --</option>
            <option value="2020">2020</option>
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
          <button onclick="fetchOrders()">Find</button>
        </div>
      </div>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>STT</th>
            <th>T√™n M√≥n ƒÇn</th>
            <th>Gi√° (VNƒê)</th>
            <th>Ng√†y cung c·∫•p</th>
            <th>H√†nh ƒê·ªông</th>
          </tr>
        </thead>
        <tbody id="orderItemsList">
          <!-- C√°c orders s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y th√¥ng qua JavaScript -->
        </tbody>
      </table>

      <div id="showTotalMoney">
        <!-- hi·ªÉn th·ªã t·ªïng s·ªë ti·ªÅn ph·∫£i tr·∫£ trong th√°ng -->
      </div>
    </main>
  </body>
  <script>
    const pathParts = window.location.pathname.split("/");
    const userId = pathParts[pathParts.length - 1];

    async function fetchOrders() {
      const month = document.getElementById("month").value;
      const year = document.getElementById("year").value;

      if (!month || !year) {
        alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√°ng v√† nƒÉm!");
        return;
      }

      try {
        const response = await fetch(
          `/api/orders/getAllOrderByUserIdForMonthYear/${userId}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ month, year }),
          }
        );

        const result = await response.json();

        if (result.status === 1) {
          const orders = result.data;
          const orderItemsList = document.getElementById("orderItemsList");
          const showTotalMoney = document.getElementById("showTotalMoney");
          orderItemsList.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©
          showTotalMoney.innerHTML = "";
          var totalMoney = 0;
          if (orders.length === 0) {
            orderItemsList.innerHTML = `<tr><td colspan="5">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong th√°ng ${month}/${year}</td></tr>`;
            return;
          }

          orders.forEach((order, index) => {
            totalMoney = totalMoney + order.price;
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${order.name_food}</td>
              <td>${(order.price ?? 0).toLocaleString()} VNƒê</td>
              <td>${new Date(order.order_date).toLocaleDateString("vi-VN")}</td>
              <td>
                <a href="#" onclick="deleteOrder(${
                  order.id
                })" class="action-btn delete-btn">Xo√°</a>
              </td>
              
            `;

            orderItemsList.appendChild(row);
          });
          showTotalMoney.innerHTML = `</br><h2>T·ªïng ti·ªÅn trong th√°ng: ${(totalMoney ?? 0).toLocaleString()} VND</h2>`;
        } else {
          alert("L·ªói khi t·∫£i ƒë∆°n h√†ng!");
        }
      } catch (error) {
        console.error("L·ªói fetchOrders:", error);
        alert(error);
      }
    }

    // H√†m x√≥a ƒë∆°n h√†ng (tu·ª≥ ch·ªçn n·∫øu b·∫°n mu·ªën h·ªó tr·ª£ x√≥a)
    async function deleteOrder(orderId) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ƒë∆°n h√†ng n√†y?")) return;

      try {
        const response = await fetch(`/api/orders/delete/${orderId}`, {
          method: "DELETE",
        });

        const result = await response.json();

        if (result.status === 1) {
          alert("Xo√° th√†nh c√¥ng!");
          fetchOrders(); // Reload danh s√°ch
        } else {
          alert("Xo√° th·∫•t b·∫°i!");
        }
      } catch (error) {
        console.error("L·ªói khi xo√° ƒë∆°n h√†ng:", error);
        alert("L·ªói server khi xo√°.");
      }
    }
  </script>
</html>
